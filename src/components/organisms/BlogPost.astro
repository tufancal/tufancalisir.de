---
import {
  storyblokEditable,
  type SbBlokData,
  renderRichText,
  type StoryblokRichTextNode,
} from "@storyblok/astro";
import type { BlogPost } from "@/.storyblok/types/285719928053161/storyblok-components";
import { formatDate, formatDateTime } from "@/src/utils/date";
import { Image } from "astro:assets";
import { generateResponsiveImageData } from "@/src/utils/optimizeImage";
import { getBlogCategory } from "@/src/utils/storyblok";
import { getBlogGlobalData } from "@/src/utils/storyblok";
import { richTextResolvers } from "@/src/utils/richTextResolvers";
import { processRichTextWithCodeHighlighting } from "@/src/utils/highlightCodeBlocks";
import { getStoryblokVersion } from "@/src/utils/env";
interface Props {
  blok: BlogPost;
  publishedAt: string;
}

const { blok, publishedAt } = Astro.props;

const blogGlobalData = await getBlogGlobalData(getStoryblokVersion());
// Extract headline anchor IDs for table of contents
const headlineAnchorIds =
  blok.copy.content
    ?.filter((item) => item.type === "heading")
    .map((heading) => {
      const anchorMark = heading.content?.[0]?.marks?.find(
        (mark) => mark.type === "anchor",
      );
      return { id: anchorMark?.attrs?.id, text: heading.content?.[0]?.text };
    })
    .filter((anchorId) => anchorId !== null && anchorId !== undefined) || [];

headlineAnchorIds.push({ id: "tl-dr", text: blogGlobalData.tl_dr_headline });
// Generate responsive image data
const image = generateResponsiveImageData(blok.image.filename as string, {
  breakpoints: [240, 320, 400, 560, 800, 1024, 1280],
  aspectRatio: 3 / 2,
  sizes:
    "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, (max-width: 1280px) 33vw, 400px",
  focus: blok.image.focus || undefined, // Focal point from Storyblok
});

const categories = await Promise.all(
  blok.category?.map((category: string) =>
    getBlogCategory(category, getStoryblokVersion()),
  ),
);

const processedCopy = await processRichTextWithCodeHighlighting(
  blok.copy as any,
);
---

<article
  class="container mx-auto max-w-3xl px-4"
  {...storyblokEditable(blok as SbBlokData)}
>
  <div class="mb-6 flex flex-col items-center gap-2">
    <div class="badge badge-outline">
      <time datetime={formatDateTime(publishedAt)}>
        {formatDate(publishedAt)}
      </time>
    </div>
    <div class="badge badge-ghost">
      {blok.author}
    </div>
    <ul class="flex flex-wrap justify-center gap-2">
      {
        categories.map((category: any) => (
          <li class={`badge badge-${category?.color}`}>
            <a href={`/blog/kategorie/${category?.value}`}>
              {category?.name}
              {category?.icon}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
  <figure class="mb-8 overflow-hidden rounded-lg shadow-md">
    <Image class="w-full" src={image.src} alt={blok.image.alt} inferSize />
  </figure>

  <div class="text-base-content mb-8 text-lg leading-relaxed font-semibold">
    <Fragment
      set:html={renderRichText(blok.introText as StoryblokRichTextNode, {
        resolvers: richTextResolvers,
      })}
    />
  </div>

  {
    headlineAnchorIds.length > 0 && (
      <div class="card bg-base-200 mb-8">
        <div class="card-body">
          <h2 class="card-title text-base-content">
            {blogGlobalData.headlines}
          </h2>
          <ul class="menu menu-sm">
            {headlineAnchorIds.map((anchor) => (
              <li>
                <a href={`#${anchor.id}`} class="link link-hover">
                  {anchor.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </div>
    )
  }

  <div
    class="prose lg:prose-lg prose-headings:text-base-content prose-p:text-base-content prose-a:text-primary prose-strong:text-base-content prose-code:text-base-content mb-8 max-w-none lg:mb-16"
  >
    <Fragment
      set:html={renderRichText(processedCopy as StoryblokRichTextNode, {
        optimizeImages: {
          width: 1024,
          height: 576,
          loading: "lazy",
          filters: {
            format: "webp",
            quality: 85,
          },
          srcset: [320, 640, 768, 1024, 1280],
          sizes: [
            "(max-width: 640px) 100vw",
            "(max-width: 1024px) 80vw",
            "1024px",
          ],
        },
        resolvers: richTextResolvers,
      })}
    />
  </div>
  {
    blok.tl_dr && (
      <section id="tl-dr" class="card bg-base-200 mb-8">
        <div class="card-body">
          <h2 class="card-title text-base-content">
            {blogGlobalData.tl_dr_headline}
          </h2>
          <div class="prose text-lg leading-relaxed font-semibold text-white">
            <Fragment
              set:html={renderRichText(blok.tl_dr as StoryblokRichTextNode, {
                resolvers: richTextResolvers,
              })}
            />
          </div>
        </div>
      </section>
    )
  }
</article>

<div id="giscus" class="container mx-auto mb-4 max-w-3xl px-4 lg:mb-8"></div>

<script is:inline>
  let giscusLoaded = false;

  function loadGiscus() {
    const giscusContainer = document.getElementById("giscus");
    if (!giscusContainer) return;

    giscusContainer.innerHTML = "";

    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.setAttribute("data-repo", "tufancal/tufancalisir.de");
    script.setAttribute("data-repo-id", "R_kgDOPXscaw");
    script.setAttribute("data-category", "General");
    script.setAttribute("data-category-id", "DIC_kwDOPXsca84C0iFm");
    script.setAttribute("data-mapping", "pathname");
    script.setAttribute("data-strict", "0");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "0");
    script.setAttribute("data-input-position", "top");
    script.setAttribute("data-theme", "preferred_color_scheme");
    script.setAttribute("data-lang", "de");
    script.setAttribute("data-loading", "lazy");
    script.crossOrigin = "anonymous";
    script.async = true;

    giscusContainer.appendChild(script);
    giscusLoaded = true;
  }

  function setupGiscusObserver() {
    const giscusContainer = document.getElementById("giscus");
    if (!giscusContainer) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !giscusLoaded) {
            loadGiscus();
            observer.disconnect();
          }
        });
      },
      {
        rootMargin: "300px",
      },
    );

    observer.observe(giscusContainer);
  }

  setupGiscusObserver();

  document.addEventListener("astro:after-swap", () => {
    giscusLoaded = false;
    setupGiscusObserver();
  });
</script>
