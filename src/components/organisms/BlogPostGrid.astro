---
import { renderRichText, type StoryblokRichTextNode } from "@storyblok/astro";
import { getStoryblokVersion } from "@/src/utils/env";
import { useStoryblokApi } from "@storyblok/astro";
import { getStoryblokVersion } from "@/src/utils/env";
import { formatDate } from "@/src/utils/date";
import { getBlogCategories } from "@/src/utils/storyblok";
import BlogPostCard from "@/src/components/molecules/BlogPostCard.astro";
import CategoryFilter from "@/src/components/molecules/CategoryFilter.astro";
import type { BlogPostGrid } from "@/.storyblok/types/285719928053161/storyblok-components";

interface Props {
  blok: BlogPostGrid;
}

const { blok } = Astro.props;
const storyblokApi = useStoryblokApi();

// Fetch all blog posts
const { data } = await storyblokApi.get("cdn/stories", {
  version: getStoryblokVersion(),
  starts_with: "blog",
  content_type: "blogPost",
});

// Fetch all categories for the filter
const categoriesMap = await getBlogCategories(getStoryblokVersion());
const categories = Array.from(categoriesMap.values());

// Transform stories into card data
const posts = data.stories.slice(0, 6).map((story: any) => {
  return {
    headline: story.content.headline,
    date: formatDate(story.published_at),
    introText: renderRichText(story.content.introText as StoryblokRichTextNode),
    slug: story.full_slug,
    image: {
      src: story.content.image.filename,
      focus: story.content.image.focus || undefined,
    },
    alt: story.content.image.alt,
    category: story.content.category,
  };
});
---

<section class="container mx-auto px-4 py-8">
  <h1 class="text-base-content mb-4 text-center text-4xl font-bold">
    {blok?.title}
  </h1>
  {
    blok?.description && (
      <div class="text-base-content/70 prose prose-lg mx-auto mb-12 text-center">
        <Fragment
          set:html={renderRichText(blok.description as StoryblokRichTextNode)}
        />
      </div>
    )
  }

  <CategoryFilter categories={categories} />

  <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {
      posts.map((post: any) => (
        <li data-post-categories={post.category?.join(",")}>
          <BlogPostCard
            category={post.category}
            headline={post.headline}
            date={post.date}
            introText={post.introText}
            slug={post.slug}
            image={post.image}
            alt={post.alt}
          />
        </li>
      ))
    }
  </ul>
</section>
