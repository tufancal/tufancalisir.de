---
import Layout from "../../../layouts/Layout.astro";
import { useStoryblokApi } from "@storyblok/astro";
import { getBlogCategories, extractSeoData } from "@/src/utils/storyblok";
import BlogPostGridCategory from "@/src/components/organisms/BlogPostGridCategory.astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import Breadcrumb from "@/src/components/molecules/Breadcrumb.astro";
import { getStoryblokVersion } from "@/src/utils/env";

export async function getStaticPaths() {
  const categories = await getBlogCategories(getStoryblokVersion());

  return Array.from(categories.values()).map((category) => {
    return { params: { kategorie: category.value } };
  });
}

const sbApi = useStoryblokApi();
const { kategorie } = Astro.params;

// Try to fetch category page content from Storyblok
let content, seo;
try {
  const { data } = await sbApi.get(`cdn/stories/blog/kategorie/${kategorie}`, {
    version: getStoryblokVersion(),
  });
  content = data.story.content;
  seo = extractSeoData(content);
} catch (error) {
  // If no story exists, use default SEO
  const categories = await getBlogCategories(getStoryblokVersion());
  const currentCategory = categories.get(kategorie);

  seo = {
    title: `${currentCategory?.name || kategorie} - Blog`,
    description: `Blog posts in der Kategorie ${currentCategory?.name || kategorie}`,
  };
  content = null;
}

const categories = await getBlogCategories(getStoryblokVersion());
const currentCategory = categories.get(kategorie);
---

<Layout seoPage={seo}>
  <Breadcrumb
    items={[
      { name: "Home", url: "/" },
      { name: "Blog", url: "/blog" },
      { name: currentCategory?.name || kategorie },
    ]}
  />
  {
    content?.body &&
      content.body.map((blok: any) => {
        if (blok.component === "blogPostGridCategory") {
          return <BlogPostGridCategory categoryValue={kategorie} blok={blok} />;
        }
        return <StoryblokComponent blok={blok} />;
      })
  }
</Layout>
